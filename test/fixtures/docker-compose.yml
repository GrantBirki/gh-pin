# This file demonstrates a simple Vault setup with MySQL as a storage backend.

services:
  vault:
    hostname: vault
    container_name: vault
    image: vault:1.11.4
    platform: linux/amd64
    restart: unless-stopped
    volumes:
      - ./files/vault.hcl:/etc/vault.hcl
    links:
      - "mysql:mysql"
    ports:
      - 8200:8200
    command: server -dev -dev-root-token-id="root"
    cap_add:
      - IPC_LOCK
    environment:
      VAULT_ADDR: "http://0.0.0.0:8200"
      VAULT_API_ADDR: "http://0.0.0.0:8200"
    depends_on:
      mysql:
        condition: service_healthy
    networks:
      - vault

  vault-shell:
    container_name: vault-shell
    image: vault:1.11.4
    platform: linux/amd64
    depends_on:
      - vault
    restart: unless-stopped
    entrypoint: sleep infinity
    environment:
      VAULT_ADDR: "http://vault:8200"
    networks:
      - vault

  mysql:
    container_name: mysql
    image: mysql:8.0
    platform: linux/amd64
    ports:
      - 3307:3307
    environment:
      MYSQL_ALLOW_EMPTY_PASSWORD: "true"
      MYSQL_ROOT_PASS: fakepassword
      MYSQL_USER: vault
      MYSQL_PASSWORD: fakepassword
      MYSQL_DATABASE: vault
    healthcheck:
      test:
        [
          "CMD",
          "mysql",
          "-h",
          "mysql",
          "-u",
          "vault",
          "--password=fakepassword",
          "-e",
          "SHOW DATABASES",
        ]
      interval: 10s
      timeout: 5s
    networks:
      - vault

networks:
  vault:
    name: vault

volumes:
  vault:
    name: vault
